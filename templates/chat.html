<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - {{ chat_session.document_name }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .chat-header {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .brand-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        .chat-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .message-user .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border: none;
            border-radius: 18px 18px 5px 18px;
        }
        
        .message-assistant .card {
            background: white !important;
            border: 1px solid #e9ecef;
            border-radius: 18px 18px 18px 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .chat-input-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        #messagesContainer {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }
        
        #messagesContainer::-webkit-scrollbar {
            width: 6px;
        }
        
        #messagesContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #messagesContainer::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Header -->
            <div class="col-12 p-3 chat-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <a href="/" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Back to Documents
                        </a>
                        <div>
                            <h5 class="mb-0" id="chatTitle">Loading..</h5>
                            <small class="text-muted" id="chatSubtitle">Loading session details..</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small" id="userGreeting"></span>
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Content -->
            <div class="col-12 d-flex flex-column chat-container" style="height: calc(100vh - 80px);">
                <div class="flex-grow-1 overflow-auto p-4" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                    <div class="text-center text-muted p-4">
                        <div class="spinner-border" role="status" style="color: #667eea;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading chat history...</p>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="p-4 chat-input-container">
                    <div class="d-flex gap-3 align-items-end">
                        <div class="flex-grow-1">
                            <textarea 
                                class="form-control" 
                                id="chatInput" 
                                placeholder="Ask a question about {{ chat_session.document_name }}..."
                                rows="2"
                                style="resize: none;"
                            ></textarea>
                        </div>
                        <button class="btn btn-outline-secondary" id="micBtn" onclick="toggleRecording()" title="Hold to speak" style="border-radius:50%; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">
                            <i class="bi bi-mic"></i>
                        </button>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()" title="Send message">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SESSION_ID = '{{ chat_session.session_id }}';
        console.log("Session ID:", SESSION_ID);

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadChatHistory();
        });

        function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!accessToken) {
                window.location.href = '/login';
                return;
            }
            
            // Update user greeting
            updateUserGreeting(user);
            
            // Verify token
            fetch('/auth/verify-token', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    return refreshAccessToken();
                }
            })
            .catch(error => {
                console.error('Authentication check failed:', error);
                window.location.href = '/login';
            });
        }

        function updateUserGreeting(user) {
            const greeting = document.getElementById('userGreeting');
            if (user.first_name) {
                greeting.textContent = `${user.first_name}`;
            } else if (user.email) {
                greeting.textContent = user.email;
            }
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('access_token', data.access_token);
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        function logout() {
            const refreshToken = localStorage.getItem('refresh_token');
            
            fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            })
            .finally(() => {
                localStorage.clear();
                window.location.href = '/login';
            });
        }

        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/sessions/${SESSION_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                const data = await response.json();
                console.log("Chat session data:", data);

                if (response.status === 401) {
                    // Token expired, try to refresh
                    await refreshAccessToken();
                    return loadChatHistory(); // Retry
                }

                if (response.status === 404) {
                    showError('Session not found or access denied');
                    setTimeout(() => window.location.href = '/', 2000);
                    return;
                }

                document.querySelector("#chatTitle").innerText =
                    data.session?.document_name || data.session?.filename || "Untitled Document";

                document.querySelector("#chatSubtitle").innerText =
                    `${(data.session?.file_type || 'pdf').toUpperCase()} • Uploaded ${data.session?.created_at?.slice(0,10) || 'Unknown'}`;

                if (data.success) {
                    renderMessages(data.chat_history);
                } else {
                    showError('Failed to load chat history');
                }
            } catch (error) {
                console.error('Error loading chat:', error);
                showError('Failed to load chat history');
            }
        }
        
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-text" style="font-size: 3rem; color: #667eea; opacity: 0.5;"></i>
                        <h5 class="mt-3">Start Your Conversation</h5>
                        <p>Ask questions about your document to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="mb-3 d-flex message-${msg.role} ${msg.role === 'user' ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="card" style="max-width: 75%;">
                        <div class="card-body py-3 px-4">
                            <small class="opacity-75 d-block mb-2 fw-bold">
                                ${msg.role === 'user' ? 'You' : 'AI Assistant'}
                            </small>
                            <div style="line-height: 1.5;">${msg.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const sendBtn = document.getElementById('sendBtn');
            
            if (!message) return;
            
            // Disable input
            input.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            
            // Add user message to UI
            addMessageToUI('user', message);
            input.value = '';
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        session_id: SESSION_ID,
                        message: message
                    })
                });
                
                if (response.status === 401) {
                    // Token expired, try to refresh and retry
                    await refreshAccessToken();
                    // Retry the request
                    return sendMessage();
                }
                
                const data = await response.json();
                
                if (data.success) {
                    addMessageToUI('assistant', data.response);
                } else {
                    showError(data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to send message');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="bi bi-send"></i>';
                input.focus();
            }
        }
        
        function addMessageToUI(role, content) {
            const container = document.getElementById('messagesContainer');
            
            // Remove empty state if exists
            const emptyState = container.querySelector('.text-center.text-muted');
            if (emptyState) emptyState.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 d-flex message-${role} ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
            
            if (role === 'assistant') {
                // Assistant messages get audio controls
                const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                messageDiv.innerHTML = `
                    <div class="card" style="max-width: 75%;">
                        <div class="card-body py-3 px-4">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <small class="opacity-75 fw-bold">AI Assistant</small>
                                <button class="btn btn-sm btn-outline-secondary" onclick="playMessageAudio('${messageId}')" id="playBtn_${messageId}" title="Play audio">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                            </div>
                            <div style="line-height: 1.5;">${content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
                messageDiv.setAttribute('data-message-id', messageId);
                messageDiv.setAttribute('data-content', content);
                
                // Auto-play audio for assistant responses
                setTimeout(() => playMessageAudio(messageId), 500);
            } else {
                // User messages (no audio)
                messageDiv.innerHTML = `
                    <div class="card" style="max-width: 75%;">
                        <div class="card-body py-3 px-4">
                            <small class="opacity-75 d-block mb-2 fw-bold">You</small>
                            <div style="line-height: 1.5;">${content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function showError(message) {
            const container = document.getElementById('messagesContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show mx-3';
            errorDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(errorDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Handle Enter key
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // ===== Voice support =====
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let activeStream = null;
        let chosenMime = '';

        async function toggleRecording() {
            try {
                if (!isRecording) {
                    await startRecording();
                } else {
                    await stopRecording();
                }
            } catch (e) {
                console.error('Mic error', e);
                showError('Microphone permission or recording failed.');
            }
        }

        async function startRecording() {
            // Pick a supported mime type
            const candidates = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/ogg;codecs=opus',
                'audio/mp4',
                '' // let browser choose
            ];
            chosenMime = candidates.find(t => t === '' || MediaRecorder.isTypeSupported(t)) || '';

            activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const opts = chosenMime ? { mimeType: chosenMime } : {};
            mediaRecorder = new MediaRecorder(activeStream, opts);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onerror = e => { console.error('Recorder error', e); showError('Recording error.'); stopRecording(); };
            mediaRecorder.onstop = onRecordingStop;
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('micBtn').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
        }

        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            // stop tracks
            if (activeStream) {
                try { activeStream.getTracks().forEach(t => t.stop()); } catch {}
                activeStream = null;
            }
            document.getElementById('micBtn').innerHTML = '<i class="bi bi-mic"></i>';
        }

        async function onRecordingStop() {
            try {
                if (!audioChunks || audioChunks.length === 0) {
                    showError('No audio captured. Try again.');
                    return;
                }
                const mimeType = chosenMime || (audioChunks[0]?.type || 'audio/webm');
                const ext = mimeType.includes('ogg') ? 'ogg' : mimeType.includes('mp4') ? 'mp4' : 'webm';
                const blob = new Blob(audioChunks, { type: mimeType });
                const formData = new FormData();
                formData.append('audio', blob, `audio.${ext}`);
                // Optional: set UI/browser language as ISO-639-1 (e.g., en, hi, te)
                const lang = (navigator.language || '').toLowerCase();
                const iso639 = lang.includes('-') ? lang.split('-')[0] : lang;
                formData.append('language', iso639);

                const sttResp = await fetch('/api/voice/stt', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
                    body: formData
                });
                const sttData = await sttResp.json();
                if (!sttData.success) {
                    showError(sttData.message || 'Transcription failed');
                    return;
                }
                const transcribed = (sttData.text || '').trim();
                if (!transcribed) {
                    showError('No speech detected');
                    return;
                }

                // Populate and send like a normal message
                document.getElementById('chatInput').value = transcribed;
                await sendMessage();

                // Optionally auto TTS the assistant response: fetch last assistant message
                // Simple approach: after a small delay, read the last assistant bubble
                setTimeout(async () => {
                    const bubbles = document.querySelectorAll('.message-assistant .card-body div');
                    if (bubbles.length) {
                        const last = bubbles[bubbles.length - 1].innerText;
                        await speakText(last);
                    }
                }, 800);

            } catch (e) {
                console.error('onRecordingStop error', e);
                showError('Voice handling failed');
            }
        }

        async function speakText(text) {
            try {
                const resp = await fetch('/api/voice/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ text: text, voice: 'alloy', format: 'mp3' })
                });
                if (!resp.ok) return;
                const arrayBuf = await resp.arrayBuffer();
                const blob = new Blob([arrayBuf], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                return audio.play();
            } catch (e) {
                console.error('TTS play error', e);
            }
        }

        // Play audio for a specific message
        async function playMessageAudio(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            const playBtn = document.getElementById(`playBtn_${messageId}`);
            const content = messageDiv.getAttribute('data-content');
            
            if (!content) return;
            
            try {
                // Update button to show loading
                playBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                playBtn.disabled = true;
                
                const resp = await fetch('/api/voice/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ text: content, voice: 'alloy', format: 'mp3' })
                });
                
                if (!resp.ok) {
                    throw new Error('TTS failed');
                }
                
                const arrayBuf = await resp.arrayBuffer();
                const blob = new Blob([arrayBuf], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                
                // Update button to show playing
                playBtn.innerHTML = '<i class="bi bi-volume-up-fill text-success"></i>';
                playBtn.title = 'Playing audio...';
                
                // Add visual indicator to the message
                messageDiv.style.borderLeft = '4px solid #28a745';
                messageDiv.style.backgroundColor = '#f8f9fa';
                
                audio.onended = () => {
                    playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    playBtn.title = 'Play audio';
                    playBtn.disabled = false;
                    messageDiv.style.borderLeft = '';
                    messageDiv.style.backgroundColor = '';
                    URL.revokeObjectURL(url);
                };
                
                audio.onerror = () => {
                    playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    playBtn.title = 'Play audio';
                    playBtn.disabled = false;
                    messageDiv.style.borderLeft = '';
                    messageDiv.style.backgroundColor = '';
                    URL.revokeObjectURL(url);
                };
                
                await audio.play();
                
            } catch (e) {
                console.error('Play message audio error', e);
                playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                playBtn.title = 'Play audio';
                playBtn.disabled = false;
            }
        }
    </script>
</body>
</html>